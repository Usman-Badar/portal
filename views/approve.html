<html>

<head>
    <meta charset="UTF-8">
    <title>Matching Signatures</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />

    <!-- jQuery library -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.slim.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
</head>

<body>
    <h1 class="text-center">Please Wait....</h1>

    <div class="container" style="max-height: 200px; overflow-y: overlay; opacity: 1;">
        <img src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/98989898/signature_to_match.png" width="100%" crossorigin='anonymous' id="test_img_to_match" alt="signature" />
    </div>

    <script>
        let socket;
        let video;
        let mobileNet;
        let classifier;
        let imgsLoaded = 1;

        $('#test_img_to_match').attr('src', "http://192.168.0.162:8888/assets/portal/assets/images/signatures/" + window.location.href.split('/').pop() + "/signature_to_match.png");

        function modelReady()
        {
            console.log("Model is ready!!!");
            socket.emit("signature_validation_process_message_for_approval", { message: 'Model Ready!!!' });
            classifier = mobileNet.classification(video, videoReady);
            classifier.load('http://192.168.0.162:8888/assets/portal/assets/images/signatures/' + window.location.href.split('/').pop() + '/model.json', customModelReady);
        }

        function videoReady( err, rslt )
        {
            console.log("Video is ready!!!");
        }

        function customModelReady()
        {
            socket.emit("signature_validation_process_message_for_approval", { message: 'Model Loaded' });
            console.log("Custom Model is loaded!!!");
            socket.emit("signature_validation_process_message_for_approval", { message: "Validating..." });
            classifier.classify(document.getElementById('test_img_to_match'), gotResults);
        }

        function gotResults( err, rslt )
        {
            socket.emit("signature_validation_process_message_for_approval", { message: JSON.stringify(rslt), final: true, emp_id: window.location.href.split('/').pop() });
        }

        function preload()
        {
            video = createCapture(VIDEO);
            mobileNet = ml5.featureExtractor('MobileNet', modelReady);
        }

        function setup()
        {
            console.log("Please Wait...");
            socket.emit("signature_validation_process_message_for_approval", { message: 'Please Wait...' });
        }
    </script>

    <script type="module">
        import { io } from "https://cdn.socket.io/4.4.1/socket.io.esm.min.js";
    
        socket = io('http://192.168.0.162:8888');

        socket.on("connect", () => {
            
            console.log('Socket Connected');
            socket.emit("signature_validation_process_connected", { connection: true });
        });

        socket.on("signature_validation_process_approve_again", () => {
            
            socket.emit("signature_validation_process_message_for_approval", { message: "Validating..." });
            $("#test_img_to_match").attr('src', 'http://192.168.0.162:8888/assets/portal/assets/images/signatures/' + window.location.href.split('/').pop() + '/signature_to_match.png?' + new Date().getTime());
            classifier.load('http://192.168.0.162:8888/assets/portal/assets/images/signatures/' + window.location.href.split('/').pop() + '/model.json', customModelReady);
        });

    </script>
</body>

</html>