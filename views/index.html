<html>

<head>
    <meta charset="UTF-8">
    <title>Multiple Image classification using MobileNet and p5.js</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />

    <!-- jQuery library -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.slim.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
</head>

<body>
    <h1 class="text-center display-1">Please Wait....</h1>
    <input type="text" disabled class="form-control mb-3" style="font-size: 100px;" id="emp_id" required />
    <input name="fileupload" id="fileupload" type="file" multiple class="form-control mb-3" style="font-size: 100px;" required />
    <button class="btn btn-primary d-block mx-auto px-5 rounded" style="font-size: 50px;" onclick="uploadFile()">Submit</button>
    <!-- <form action="http://192.168.0.162:8888/save/modal" method="post" enctype="multipart/form-data">
    </form> -->

    <div class="container" style="max-height: 200px; overflow-y: overlay; opacity: 0;">
        <div class="row">
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/default_signature_1.png" crossorigin='anonymous' id="img10" alt="10 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/default_signature_2.png" crossorigin='anonymous' id="img11" alt="11 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/default_signature_3.png" crossorigin='anonymous' id="img12" alt="12 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/other_signature_1.png" crossorigin='anonymous' id="img1" alt="1 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/other_signature_2.png" crossorigin='anonymous' id="img2" alt="2 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/other_signature_3.png" crossorigin='anonymous' id="img3" alt="3 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/other_signature_4.png" crossorigin='anonymous' id="img4" alt="4 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/other_signature_5.png" crossorigin='anonymous' id="img5" alt="5 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/other_signature_6.png" crossorigin='anonymous' id="img6" alt="6 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/other_signature_7.png" crossorigin='anonymous' id="img7" alt="7 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/other_signature_8.png" crossorigin='anonymous' id="img8" alt="8 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img width="100%" src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/other_signature_9.png" crossorigin='anonymous' id="img9" alt="9 signature" />
            </div>
            <div class="col-lg-2 col-md-4 col-sm-12">
                <img src="http://192.168.0.162:8888/assets/portal/assets/images/signatures/other_signature_9.png" width="100%" crossorigin='anonymous' id="test_img_to_match" alt="13 signature" />
            </div>
        </div>
    </div>

    <script>
        let socket;
        let video;
        let mobileNet;
        let classifier;
        let imgsLoaded = 1;
        
        async function uploadFile() {
            let arr = Object.keys(document.getElementById('fileupload').files).map((key) => [document.getElementById('fileupload').files[key]]);
            let formData = new FormData(); 
            formData.append('emp_id', window.location.href.split('/').pop())
            arr.forEach(file => {
                console.log(file[0])
                formData.append("Attachments", file[0]);
            });

            setTimeout(() => {
                window.close();
            }, 3000);

            let result = await fetch('http://192.168.0.162:8888/save/modal', {
                method: "POST",
                body: formData,
            }); 

            if ( result.statusText === "OK" )
            {
                socket.emit("signature_validation_process_model_saved", { saved: true });
            }
        }

        $('button').prop("disabled", true);
        $('#emp_id').val(window.location.href.split('/').pop());

        function modelReady()
        {
            $('h1').text("Model is ready!!!");
            console.log("Model is ready!!!");
            socket.emit("signature_validation_process_message", { message: 'Setup Started' });
            classifier = mobileNet.classification(video, videoReady);
            setTimeout(() => {
                startLoadingImages();
            }, 300);
        }

        function videoReady( err, rslt )
        {
            console.log("Video is ready!!!");
            socket.emit("signature_validation_process_message", { message: 'Video is ready!!!' });
            // setTimeout(() => {
            //     startLoadingImages();
            // }, 300);
        }

        function startLoadingImages()
        {
            $('h1').text("Loading img" + imgsLoaded);
            console.log("Loading ", 'img' + imgsLoaded);
            socket.emit("signature_validation_process_message", { message: "Loading img" + imgsLoaded });
            mobileNet.addImage(document.getElementById('img' + imgsLoaded), imgsLoaded > 9 ? 'matched' : 'not_matched', signatureSaved);
        }

        function whileTraining( loss )
        {
            if ( !loss )
            {
                $('h1').text("Model has trained successfully!!!");
                console.log("Model has trained successfully!!!");
                socket.emit("signature_validation_process_message", { message: "Applications is ready!!" });
                setTimeout(() => {
                    Train();
                }, 500);
            }else
            {
                $('h1').text("Training....");
                socket.emit("signature_validation_process_message", { message: "Trained: ", loss: loss });
                console.log("Trained: ", loss);
            }
        }

        function validating()
        {
            $('h1').text("Process Completed...");
            console.log("Process Completed...");
            socket.emit("signature_validation_process_message", { message: "Validating..." });
            $('button').prop("disabled", false);
            classifier.save();
            // classifier.classify(document.getElementById('test_img_to_match'), gotResults);
        }

        // function gotResults( err, rslt )
        // {
        //     console.log(rslt);
        //     socket.emit("signature_validation_process_message", { message: JSON.stringify(rslt), final: true });
        //     $('button').prop("disabled", false);
        // }

        function signatureSaved( err, rslt )
        {
            if (err)
            {
                console.log( err );
            }else
            {
                if ( imgsLoaded === 12 )
                {
                    $('h1').text("All signatures are loaded!!!");
                    console.log("All signatures are loaded!!!");
                    socket.emit("signature_validation_process_message", { message: 'All Signatures Are Loaded...' });
                    classifier.train(whileTraining);       
                }else
                {
                    imgsLoaded = imgsLoaded + 1;
                    startLoadingImages();
                }
            }
        }

        function preload()
        {
            video = createCapture(VIDEO);
            mobileNet = ml5.featureExtractor('MobileNet', modelReady);
        }

        function setup()
        {
            $('h1').text("Please Wait...");
            console.log("Please Wait...");
            socket.emit("signature_validation_process_message", { message: 'Please Wait...' });
        }

        function Train()
        {
            setTimeout(() => {
                validating();
            }, 300);
        }
    </script>

    <script type="module">
        import { io } from "https://cdn.socket.io/4.4.1/socket.io.esm.min.js";
    
        socket = io('http://192.168.0.162:8888');

        socket.on("connect", () => {
            
            console.log('Socket Connected');
            socket.emit("signature_validation_process_connected", { connection: true });
        });

        socket.on("signature_validation_process_start", () => {
            Train();
        });
    </script>
</body>

</html>